# トラック仕様書: Advanced Observability & Security (Tracing PII Protection & Masking)

## 概要
このトラックでは、システムの観測性（Observability）を向上させつつ、ログやトレースに含まれる個人情報（PII: Personally Identifiable Information）を自動的に保護する仕組みを導入します。柔軟なハイブリッドアプローチを採用し、ドメイン層でのメタデータ付与とインフラ層での動的なマスキング制御を組み合わせます。

## 機能要件

### 1. PII マーカートレイトの導入
- `domain` クレートに `PiiSensitive` トレイトを定義する。
- 以下の型にこのトレイトを実装する：
    - `Email`
    - `PasswordHash`
    - `SecretToken` (JWT 等)

### 2. カスタム Tracing レイヤーの実装
- `infrastructure` クレートに `PiiMaskingLayer` を実装する。
- このレイヤーは、`tracing` イベントのフィールドをスキャンし、`PiiSensitive` を実装している値、または特定のフィールド名（`email`, `password`, `token` 等）を検知してマスキングを行う。

### 3. 部分隠蔽（Partial Masking）ロジック
- データの形式を維持しつつ、中間部分を隠蔽するロジックを実装する。
    - Email: `test@example.com` -> `t***@example.com`
    - Token/Hash: `v1.abc123xyz` -> `v1.***xyz`

### 4. 環境に応じた動的制御
- `config` クレートおよび環境変数を使用して、マスキングの有効/無効を切り替え可能にする。
- 開発環境（Local）では詳細なデバッグのために無効化を許容し、本番環境（Production/Jaeger出力）では強制的に有効化する。

## 非機能要件
- **パフォーマンス:** ログ出力時のスキャンによるオーバーヘッドを最小限に抑える（特に高頻度なイベントにおいて）。
- **安全性:** 新しい PII 型が追加された際に、トレイトを実装し忘れてもフィールド名ベースのフォールバックで最低限の保護が行われること。

## 受入条件
- [ ] `Email` を含むログを出力した際、設定が有効であれば `t***@example.com` の形式で出力されること。
- [ ] Jaeger (OpenTelemetry) に送信されるスパンの属性においても、PII がマスキングされていること。
- [ ] 環境変数の切り替えにより、マスキングの有無が動的に変化すること。
- [ ] テストコードにより、隠蔽ロジックが正しく動作（境界値や空文字のハンドリング等）することが証明されていること。

## スコープ外
- データベース（PostgreSQL）内に保存されているデータの暗号化（本トラックは「トレーシング/ロギング」に特化）。
- ファイルシステム上のログファイルの直接的な事後加工。
