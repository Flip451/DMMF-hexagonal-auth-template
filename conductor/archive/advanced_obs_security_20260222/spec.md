# トラック仕様書: Advanced Observability & Security (Tracing Sensitive Data Protection & Masking)

## 概要
このトラックでは、システムの観測性（Observability）を向上させつつ、機密情報を自動的に保護する仕組みを導入します。「ハイブリッドアプローチ」を採用し、以下の2軸で安全性を確保します。
1.  **静的保護:** 型システムと隠蔽アルゴリズムによる、実装レベルでの機密情報の特定と保護。
2.  **動的制御:** 設定（config）による、環境（本番 vs 開発）に応じたマスキングの有効/無効の柔軟な切り替え。

隠蔽のコア知識を独立した `libs/sensitive_data` クレートに集約し、アーキテクチャ全体で一貫した機密情報の扱いを実現します。

## 機能要件

### 1. 機密情報保護の独立したクレート化 (`libs/sensitive_data`)
- 共通の隠蔽ルールとラッパーを提供する独立したクレートを作成する。
- **`SensitiveData` トレイト:** 静的な隠蔽ロジック（`mask_raw`）を定義。
- **マーカー型 (`EmailRule`, `PlainRule` 等):** 隠蔽ルールのみを抽象化したマーカーを定義し、API層とドメイン層で共有する。
- **`Sensitive<T, S>`:** 境界領域（DTO）向けの汎用ラッパー。

### 2. 環境に応じた柔軟な「ハイブリッド」切り替え制御
- **グローバルスイッチ:** `telemetry.mask_sensitive_data` 設定により、システム全体のマスキング動作を一括制御する。
- **開発環境:** デバッグ効率を優先し、マスキングをオフにして生の値をログに出力することを許容する。
- **本番環境:** セキュリティを優先し、マスキングを強制的に有効化する。

### 3. 多層的な保護の適用
- **ドメイン層:** `Email`, `PasswordHash` 等に `SensitiveData` を実装し、型レベルで保護。
- **API層:** `Sensitive<String, EmailRule>` 等を使用し、DTOレベルで疎結合に保護。
- **インフラ層:** `MaskingFormatter` による、未型化フィールドに対する名前ベースのフォールバック保護。

## 受入条件
- [ ] API 層の DTO がドメインモデルに依存せず、かつ適切な隠蔽ルールを適用できていること。
- [ ] 設定ファイル（`config`）や環境変数を書き換えるだけで、コードを修正せずにログのマスキングの有無が切り替わること。
- [ ] 本番環境（Productionモード）では設定にかかわらずマスキングが有効になる安全装置が組み込まれていること。
- [ ] シリアライズ/デシリアライズの結果にはマスキングが一切影響しないこと。
