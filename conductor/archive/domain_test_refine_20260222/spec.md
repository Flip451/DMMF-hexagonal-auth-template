# トラック仕様書: ドメインとテスト可能性の洗練 (Domain & Testability Refinement)

## 概要
このトラックでは、ドメイン層の純粋性、テスト可能性、およびパフォーマンスの向上に焦点を当てます。時刻とID生成を抽象化することで、決定論的（再現可能）なユニットテストを可能にします。また、IDシステムを UUID v7 に近代化することで、データベースの効率とソート順を改善します。さらに、DDDエンティティ用のカスタム derive マクロを作成し、識別子（Identity）と等価性（Equality）に関するアーキテクチャパターンを強制しつつ、定型コード（ボイラープレート）を削減します。

## 機能要件

### 1. 時刻（Clock）の抽象化
- `domain` クレートに `Clock` トレイトを定義する: `pub trait Clock: Send + Sync { fn now(&self) -> DateTime<Utc>; }`
- プロダクション用の `RealClock` と、テスト用の `FixedClock` を実装する。
- すべてのドメインロジックおよびユースケースで `Utc::now()` の代わりに `Clock` トレイトを使用するように変更する。

### 2. ID生成と UUID v7
- ID生成を抽象化するための `IdGenerator<T>` トレイト（または特定の `UserIdGenerator`）を定義する。
- UUID v7 による生成を実装する。その際、同一トランザクション/コンテキスト内で生成された ID が厳密なソート順を維持できるようにする。
- テスト用に、予測可能な ID シーケンスを生成する `MockIdGenerator` を実装する。

### 3. DDD エンティティ用 derive マクロ
- 識別子に基づいたロジックを自動化するための手続き型マクロを作成する。
- **構造体 (Structs) の場合:** `#[entity(id)]` を使用して識別子フィールドをマークする。このフィールドのみに基づいて `PartialEq` および `Eq` を自動的に実装する。
- **列挙型 (Enums) の場合:** バリアントが単一の引数を持つタプルであることを要求する。内部の型（これもエンティティトレイトを実装している必要がある）に識別子のロジックを委譲する。

## 非機能要件
- **アーキテクチャ境界:** トレイトは `domain` クレートに配置し、実装（Real/Fixed/Mock）は `infrastructure` または `domain::test_utils` に配置する。
- **パフォーマンス:** UUID v7 の実装は、高並列なデータベース挿入に対して効率的であること。
- **ボイラープレート削減:** `PartialEq` や `id()` ゲッターの手動実装を大幅に削減すること。

## 受入条件
- [ ] `Clock` および `IdGenerator` トレイトが既存のユースケースに統合されていること。
- [ ] `AuthUseCase` 等のユニットテストが `FixedClock` と `MockIdGenerator` を使用し、100%決定論的な結果（再現性のあるテスト）を得られること。
- [ ] すべての `UserId` が UUID v7 にアップグレードされていること。
- [ ] DDD エンティティマクロが実装され、少なくとも `User` モデルとその関連 Enum に適用されていること。
- [ ] テストにより、エンティティの `PartialEq` が全フィールドではなく ID のみで正しく比較されていることが確認できること。

## スコープ外
- 既存のすべてのデータベースレコードの UUID v7 への完全な移行（新規レコード生成とモデル構造に焦点を当てる）。
- 共通基盤として必要でない限り、ユーザー関連以外のドメインへのこれらの抽象化の適用。
