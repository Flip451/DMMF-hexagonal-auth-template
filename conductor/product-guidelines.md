# プロダクトガイドライン

## 設計原則
- **型による制約:** 不正な状態を型システムで表現不可能にする（Make Illegal States Unrepresentable）。
- **疎結合の維持:** ヘキサゴナルアーキテクチャを厳守し、ドメインロジックが特定のライブラリやフレームワークに依存しないようにします。
- **直感的な構造:** 叫ぶアーキテクチャを採用し、ディレクトリ構造自体が「認証」や「ユーザー管理」といったビジネス機能を示唆するようにします。

## ドキュメントとコメントの基準
- **「なぜ」の記述:** コードが「どのように」動くかだけでなく、その設計を選択した「理由」を日本語で詳細に記述します。
- **Rustdoc の活用:** 公開 API には `///` を使用した Rustdoc を必須とし、サンプルコードを含めることで利用方法を明示します。
- **自己説明的なコード:** 明快な命名と「叫ぶ」フォルダ構造を優先し、ドキュメントを読まなくても全体の流れが把握できるように努めます。

## 開発フロー
- **テスト駆動の推奨:** ドメインロジックの純粋性を活かし、ユニットテストを開発プロセスの中心に据えます。
- **継続的なリファクタリング:** アーキテクチャの整合性を保つため、機能追加時にも構造の健全性を常にチェックします。

## DB設計ガイドライン：共通カラム

データ調査、トラブルシューティング、データ移行などのシステム運用での利用を想定し、原則として**全てのテーブル**に以下の共通カラムを付与します。

### 共通カラム一覧
| 分類 | 項目名 | 論理名 | 作成 | 更新 | 備考 |
| :--- | :--- | :--- | :---: | :---: | :--- |
| 作成 | `created_at` | 作成日時 | ✔ | | |
| | `created_by` | 作成者 | ✔ | | ログインユーザID、またはシステム名 |
| | `created_pgm_cd` | 作成プログラムコード | ✔ | | 機能やプログラムを一意に識別する値 |
| | `created_tx_id` | 作成トランザクションID | ✔ | | API呼び出し等で一意となるID |
| 更新 | `updated_at` | 更新日時 | ✔ | ✔ | INSERT時にも登録 |
| | `updated_by` | 更新者 | ✔ | ✔ | INSERT時にも登録 |
| | `updated_pgm_cd` | 更新プログラムコード | ✔ | ✔ | INSERT時にも登録 |
| | `updated_tx_id` | 更新トランザクションID | ✔ | ✔ | INSERT時にも登録 |
| 排他制御 | `lock_no` | ロック番号 | ✔ | ✔ | デフォルト値: 1 |
| パッチ | `patched_at` | パッチ日時 | | | データパッチ時以外はNULL |
| | `patched_by` | パッチ実行者 | | | データパッチ時以外はNULL |
| | `patched_id` | パッチID | | | チケット番号等。パッチ時以外はNULL |

### テーブル設計ルール
- 追記のみ（更新がない）テーブルであっても、一律的に全分類のカラムを付与します。
- これにより、運用時の記録漏れを防ぎ、ガバナンスを担保します。

### アプリケーションコードからの利用ルール
- **ドメインモデルの純粋性:** `created_at` や `updated_by` などの共通カラムはビジネスロジックに不要なため、ドメイン層の構造体には含めません。
- **参照の禁止:** 共通カラムをアプリケーションロジックで利用（参照）してはいけません。業務要件として「最終更新日」などが必要な場合は、共通カラムとは別に業務用のカラムを定義します。
- **プレースホルダーの利用:** `created_at` や `updated_at` に `CURRENT_TIMESTAMP` を使用せず、アプリケーション側で値を生成し、プレースホルダーを用いてバインドします。これにより、単体テストでの検証を容易にします。
- **リポジトリ層での管理:** 共通カラムの付与・更新はリポジトリ実装（インフラ層）で行います。
- **排他制御の扱い:** `lock_no` は更新時に必要となるため、アプリケーション層でメタデータとして扱うか、コマンドの引数として渡します。ドメインロジック内部の計算には使用しません。
