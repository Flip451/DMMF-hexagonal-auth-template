[config]
skip_core_tasks = true
default_to_workspace = false

[env]
DOCKER_BUILDKIT = "1"
COMPOSE_DOCKER_CLI_BUILD = "1"

[tasks.help]
description = "ヘルプを表示"
command = "cargo"
args = ["make", "--list-all-steps"]

# Docker 操作
[tasks.build]
description = "Docker イメージのビルド"
command = "docker"
args = ["compose", "--profile", "tools", "build"]

[tasks.up]
description = "コンテナの起動"
command = "docker"
args = ["compose", "up", "-d"]

[tasks.down]
description = "コンテナの停止"
command = "docker"
args = ["compose", "down"]

[tasks.restart]
description = "コンテナの再起動"
command = "docker"
args = ["compose", "restart"]

[tasks.logs]
description = "ログの表示"
command = "docker"
args = ["compose", "logs", "-f", "app"]

[tasks.ps]
description = "コンテナの状態確認"
command = "docker"
args = ["compose", "ps"]

[tasks.shell]
description = "ツールコンテナにシェルで入る"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "bash"]

[tasks.db-shell]
description = "PostgreSQL CLI に接続"
command = "docker"
args = ["compose", "exec", "db", "psql", "-U", "user", "-d", "myapp"]

# SQLx 操作
[tasks.migrate-add]
description = "新規マイグレーション作成 (使用例: cargo make migrate-add create_users)"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "sqlx", "migrate", "add", "${@}"]

[tasks.migrate-run]
description = "マイグレーションの実行"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "sqlx", "migrate", "run"]

[tasks.migrate-status]
description = "マイグレーションの状態確認"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "sqlx", "migrate", "info"]

[tasks.migrate-revert]
description = "マイグレーションのロールバック"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "sqlx", "migrate", "revert"]

[tasks.sqlx-prepare]
description = "SQLx のオフライン用データを生成 (.sqlx/ フォルダ)"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "sqlx", "prepare", "--", "--all-targets", "--all-features"]

# アプリケーション操作 (appコンテナを使用)
[tasks.bacon-test]
description = "テストを継続的に実行 (baconを使用)"
command = "docker"
args = ["compose", "exec", "app", "bacon", "test", "--headless"]

# CI/品質管理 (ローカル環境で実行)
[tasks.fmt-local]
description = "コードのフォーマット"
command = "cargo"
args = ["fmt", "--all"]

[tasks.clippy-local]
description = "静的解析"
command = "cargo"
args = ["clippy", "--all-targets", "--all-features", "--", "-D", "warnings"]

[tasks.test-local]
description = "テストの実行"
command = "cargo"
args = ["test", "--workspace", "--all-targets", "--all-features"]

[tasks.check-local]
description = "ビルドチェック"
command = "cargo"
args = ["check", "--workspace", "--all-targets", "--all-features"]

[tasks.deny-local]
description = "依存関係のチェック (cargo-deny)"
command = "cargo"
args = ["deny", "check", "-D", "warnings"]

[tasks.check-layers-local]
description = "レイヤー依存関係のチェック (custom script)"
command = "bash"
args = ["./scripts/check_layers.sh"]

[tasks.machete-local]
description = "未使用の依存関係のチェック (cargo-machete)"
command = "cargo"
args = ["machete"]

[tasks.ci-local]
description = "CI 統合チェック (fmt, clippy, test, check, deny, check-layers, machete)"
dependencies = ["fmt-local", "clippy-local", "test-local", "check-local", "deny-local", "check-layers-local", "machete-local"]

# CI/品質管理 (sqlx-cliコンテナを使用)
[tasks.fmt]
description = "コードのフォーマット"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "make", "fmt-local"]

[tasks.clippy]
description = "静的解析"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "make", "clippy-local"]

[tasks.test]
description = "テストの実行"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "make", "test-local"]

[tasks.check]
description = "ビルドチェック"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "make", "check-local"]

[tasks.deny]
description = "依存関係のチェック (cargo-deny)"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "make", "deny-local"]

[tasks.check-layers]
description = "レイヤー依存関係のチェック (custom script)"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "make", "check-layers-local"]

[tasks.machete]
description = "未使用の依存関係のチェック (cargo-machete)"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "make", "machete-local"]

[tasks.ci]
description = "CI 統合チェック (fmt, clippy, test, check, deny, check-layers, machete)"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "make", "ci-local"]

[tasks.commit]
description = "CI チェック後にコミットを実行"
dependencies = ["ci"]
command = "git"
args = ["commit", "-m", "${@}"]

[tasks.clean]
description = "クリーンアップ"
command = "docker"
args = ["compose", "--profile", "tools", "down", "--volumes", "--remove-orphans"]
