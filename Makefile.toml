[config]
skip_core_tasks = true

[env]
DOCKER_BUILDKIT = "1"
COMPOSE_DOCKER_CLI_BUILD = "1"
DATABASE_URL = "postgres://user:password@localhost:5432/myapp"

[tasks.help]
description = "ヘルプを表示"
command = "cargo"
args = ["make", "--list-all-steps"]

# Docker 操作
[tasks.build]
description = "Docker イメージのビルド"
command = "docker"
args = ["compose", "build"]

[tasks.up]
description = "コンテナの起動"
command = "docker"
args = ["compose", "up", "-d"]

[tasks.down]
description = "コンテナの停止"
command = "docker"
args = ["compose", "down"]

[tasks.restart]
description = "コンテナの再起動"
dependencies = ["down", "up"]

[tasks.logs]
description = "ログの表示"
command = "docker"
args = ["compose", "logs", "-f", "app"]

[tasks.ps]
description = "コンテナの状態確認"
command = "docker"
args = ["compose", "ps"]

[tasks.shell]
description = "appコンテナにシェルで入る"
command = "docker"
args = ["compose", "run", "--rm", "app", "bash"]

# SQLx 操作
[tasks.migrate-add]
description = "新規マイグレーション作成 (使用例: cargo make migrate-add create_users)"
command = "docker"
args = ["compose", "run", "--rm", "sqlx-cli", "migrate", "add", "${@}"]

[tasks.migrate-run]
description = "マイグレーションの実行"
command = "docker"
args = ["compose", "run", "--rm", "sqlx-cli", "migrate", "run"]

[tasks.migrate-revert]
description = "マイグレーションのロールバック"
command = "docker"
args = ["compose", "run", "--rm", "sqlx-cli", "migrate", "revert"]

[tasks.sqlx-prepare]
description = "SQLx のオフライン用データを生成 (.sqlx/ フォルダ)"
command = "docker"
args = ["compose", "run", "--rm", "app", "cargo", "sqlx", "prepare", "--", "--all-targets", "--all-features"]

# アプリケーション操作
[tasks.run]
description = "アプリケーションの実行"
command = "docker"
args = ["compose", "exec", "app", "cargo", "run"]

[tasks.watch]
description = "ホットリロード有効で実行"
command = "docker"
args = ["compose", "exec", "app", "cargo", "watch", "-x", "run"]

# CI/品質管理
[tasks.fmt]
description = "コードのフォーマット"
command = "docker"
args = ["compose", "run", "--rm", "app", "cargo", "fmt", "--all"]

[tasks.clippy]
description = "静的解析"
command = "docker"
args = ["compose", "run", "--rm", "app", "cargo", "clippy", "--all-targets", "--all-features", "--", "-D", "warnings"]

[tasks.test]
description = "テストの実行"
command = "docker"
args = ["compose", "run", "--rm", "app", "cargo", "test", "--workspace"]

[tasks.check]
description = "ビルドチェック"
command = "docker"
args = ["compose", "run", "--rm", "app", "cargo", "check", "--workspace", "--all-features"]

[tasks.ci]
description = "CI 統合チェック (fmt, clippy, test, check)"
dependencies = ["fmt", "clippy", "test", "check"]

[tasks.clean]
description = "クリーンアップ"
command = "docker"
args = ["compose", "down", "--volumes", "--remove-orphans"]
