[config]
skip_core_tasks = true
default_to_workspace = false

[env]
DOCKER_BUILDKIT = "1"
COMPOSE_DOCKER_CLI_BUILD = "1"
DATABASE_URL = "postgres://user:password@localhost:5432/myapp"

[tasks.help]
description = "ヘルプを表示"
command = "cargo"
args = ["make", "--list-all-steps"]

# Docker 操作
[tasks.build]
description = "Docker イメージのビルド"
command = "docker"
args = ["compose", "--profile", "tools", "build"]

[tasks.up]
description = "コンテナの起動"
command = "docker"
args = ["compose", "up", "-d"]

[tasks.down]
description = "コンテナの停止"
command = "docker"
args = ["compose", "down"]

[tasks.restart]
description = "コンテナの再起動"
dependencies = ["down", "up"]

[tasks.logs]
description = "ログの表示"
command = "docker"
args = ["compose", "logs", "-f", "app"]

[tasks.ps]
description = "コンテナの状態確認"
command = "docker"
args = ["compose", "ps"]

[tasks.shell]
description = "ツールコンテナにシェルで入る"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "bash"]

[tasks.db-shell]
description = "PostgreSQL CLI に接続"
command = "docker"
args = ["compose", "exec", "db", "psql", "-U", "user", "-d", "myapp"]

# SQLx 操作
[tasks.migrate-add]
description = "新規マイグレーション作成 (使用例: cargo make migrate-add create_users)"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "sqlx", "migrate", "add", "${@}"]

[tasks.migrate-run]
description = "マイグレーションの実行"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "sqlx", "migrate", "run"]

[tasks.migrate-status]
description = "マイグレーションの状態確認"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "sqlx", "migrate", "info"]

[tasks.migrate-revert]
description = "マイグレーションのロールバック"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "sqlx", "migrate", "revert"]

[tasks.sqlx-prepare]
description = "SQLx のオフライン用データを生成 (.sqlx/ フォルダ)"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "sqlx", "prepare", "--", "--all-targets", "--all-features"]

# アプリケーション操作 (appコンテナを使用)
[tasks.run]
description = "アプリケーションの実行"
command = "docker"
args = ["compose", "exec", "app", "cargo", "run"]

[tasks.watch]
description = "ホットリロード有効で実行 (baconを使用)"
command = "docker"
args = ["compose", "exec", "app", "bacon", "run", "--headless"]

# CI/品質管理 (sqlx-cliコンテナを使用)
[tasks.fmt]
description = "コードのフォーマット"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "fmt", "--all"]

[tasks.clippy]
description = "静的解析"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "clippy", "--all-targets", "--all-features", "--", "-D", "warnings"]

[tasks.test]
description = "テストの実行"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "test", "--workspace"]

[tasks.check]
description = "ビルドチェック"
command = "docker"
args = ["compose", "--profile", "tools", "run", "--rm", "sqlx-cli", "cargo", "check", "--workspace", "--all-features"]

[tasks.ci]
description = "CI 統合チェック (fmt, clippy, test, check)"
dependencies = ["fmt", "clippy", "test", "check"]

[tasks.commit]
description = "CI チェック後にコミットを実行"
dependencies = ["ci"]
command = "git"
args = ["commit"]

[tasks.clean]
description = "クリーンアップ"
command = "docker"
args = ["compose", "--profile", "tools", "down", "--volumes", "--remove-orphans"]
